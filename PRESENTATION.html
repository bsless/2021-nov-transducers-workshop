<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Structure and Interpretation of Clojure Transducers</title>
<meta name="author" content="(Ben Sless)"/>
<style type="text/css">
.underline { text-decoration: underline; }
</style>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js/dist/reveal.css"/>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js/dist/theme/moon.css" id="theme"/>


<!-- If the query includes 'print-pdf', include the PDF print sheet -->
<script>
    if( window.location.search.match( /print-pdf/gi ) ) {
        var link = document.createElement( 'link' );
        link.rel = 'stylesheet';
        link.type = 'text/css';
        link.href = 'https://cdn.jsdelivr.net/npm/reveal.js/css/print/pdf.css';
        document.getElementsByTagName( 'head' )[0].appendChild( link );
    }
</script>
</head>
<body>
<div class="reveal">
<div class="slides">
<section id="sec-title-slide"><h1 class="title">Structure and Interpretation of Clojure Transducers</h1><h2 class="author">Ben Sless</h2><p class="date">Created: 2021-11-12 Fri 18:42</p>
</section>

<section>
<section id="slide-org1a286d2">
<h2 id="org1a286d2">Who am I?</h2>
<div class="outline-text-2" id="text-org1a286d2">
</div>
</section>
<section id="slide-org2e7c694">
<h3 id="org2e7c694">I'm Ben</h3>

</section>
<section id="slide-orgf05b217">
<h3 id="orgf05b217">I Love Clojure</h3>

</section>
<section id="slide-org4738d68">
<h3 id="org4738d68">Clojure-ing professionally 3 years</h3>

</section>
</section>
<section>
<section id="slide-org599c08a">
<h2 id="org599c08a">Why Transducers?</h2>
<div class="outline-text-2" id="text-org599c08a">
</div>
</section>
<section id="slide-orge60d061">
<h3 id="orge60d061">General Building Blocks</h3>
<div class="outline-text-3" id="text-orge60d061">
</div>
</section>
<section id="slide-org6fca57c">
<h4 id="org6fca57c">Code Reuse is Good!</h4>

</section>
<section id="slide-org9a8de90">
<h4 id="org9a8de90">Reuse in different contexts</h4>

</section>
<section id="slide-org31fc433">
<h3 id="org31fc433">Beautiful Code</h3>

</section>
<section id="slide-org4dcb5af">
<h3 id="org4dcb5af">Decomplect Processing from Everything Else</h3>
<div class="outline-text-3" id="text-org4dcb5af">
</div>
</section>
<section id="slide-org91c9b0a">
<h4 id="org91c9b0a">Why can't we <code>map</code> and <code>filter</code> over everything?</h4>
<div class="outline-text-4" id="text-org91c9b0a">
</div>
<ul class="org-ul">
<li><a id="orgee744bf"></a>Sequences<br /></li>

<li><a id="org018c723"></a>Collections<br /></li>

<li><a id="org96aa8d5"></a>Channels<br /></li>

<li><a id="orga7f33a5"></a>Flow and Streams<br /></li>
</ul>

</section>
<section id="slide-orgcd5cdc0">
<h3 id="orgcd5cdc0">Performance</h3>
<div class="outline-text-3" id="text-orgcd5cdc0">
</div>
</section>
<section id="slide-org5b87872">
<h4 id="org5b87872">Control over processing characteristics</h4>
<p>
Lazy vs. Eager
</p>

</section>
<section id="slide-org40955ae">
<h4 id="org40955ae">Less allocation</h4>

</section>
<section id="slide-org20bcd65">
<h4 id="org20bcd65">JIT friendly</h4>

</section>
</section>
<section>
<section id="slide-orga6fe77e">
<h2 id="orga6fe77e">DIY Transducers</h2>
<ul>
<li>Transducers are deeply tied to the idea of reducing processes.</li>
<li>To fully grok them, we should begin by understanding how <code>reduce</code> is
implemented.</li>
<li>It is often said the best way to understand a subject is to apply it
or implement it ourselves.</li>

</ul>

</section>
</section>
<section>
<section id="slide-org0e7c9ca">
<h2 id="org0e7c9ca">Loop and Reduce</h2>
<div class="outline-text-2" id="text-org0e7c9ca">
</div>
</section>
<section id="slide-org730e5b1">
<h3 id="org730e5b1">Reduce</h3>
<p>
Reduce takes three arguments (putting aside the two arguments case):
</p>
<ul>
<li>A function:
<code>accumulator -&gt; element -&gt; accumulator</code></li>
<li>An initial value for the accumulator</li>
<li>A collection to take elements from</li>

</ul>

</section>
<section id="slide-orgd60ad2a">
<h3 id="orgd60ad2a">Implementing Reduce</h3>
<p>
Iterating over the elements of the collection:
</p>
<ul>
<li>If we have consumed the entire collection
<ul>
<li>return the accumulator</li>

</ul></li>
<li>If not,
<ul>
<li>combine the accumulator with the head element with our function</li>
<li>recur with the updated accumulator and the rest of the collection</li>

</ul></li>

</ul>

</section>
<section id="slide-org8c6d8e2">
<h3 id="org8c6d8e2">Translated directly to code</h3>
<div class="org-src-container">

<pre  class="src src-clojure"   ><code trim><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">defn</span> <span style="color: #bc6ec5; font-weight: bold;">-reduce</span>
  <span style="color: #bc6ec5;">[</span>rf accum coll<span style="color: #bc6ec5;">]</span>
  <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">if we have not consumed the entire collection</span>
  <span style="color: #bc6ec5;">(</span><span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>seq coll<span style="color: #2d9574;">)</span>
    <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">separate the head of the collection from the rest of it</span>
    <span style="color: #2d9574;">(</span><span style="color: #4f97d7; font-weight: bold;">let</span> <span style="color: #67b11d;">[</span><span style="color: #b1951d;">[</span>head &amp; tail<span style="color: #b1951d;">]</span> coll
          <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">combine the accumulator with the head element</span>
          <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">with our function</span>
          accum <span style="color: #b1951d;">(</span>rf accum head<span style="color: #b1951d;">)</span><span style="color: #67b11d;">]</span>
      <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">recur with the updated `</span><span style="color: #a45bad; background-color: #292e34;">accum</span><span style="color: #2aa1ae; background-color: #292e34;">` and the</span>
      <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">rest of the collection</span>
      <span style="color: #67b11d;">(</span><span style="color: #4f97d7; font-weight: bold;">recur</span> rf accum tail<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
    accum<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span> <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">otherwise, return the accumulator</span>
</code></pre>
</div>
</section>
<section id="slide-orgdf529df">
<h3 id="orgdf529df">Translated directly to code</h3>
<div class="org-src-container">

<pre  class="src src-clojure"   ><code trim><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">defn</span> <span style="color: #bc6ec5; font-weight: bold;">-reduce</span>
  <span style="color: #bc6ec5;">[</span>rf accum coll<span style="color: #bc6ec5;">]</span>
  <span style="color: #bc6ec5;">(</span><span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>seq coll<span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span><span style="color: #4f97d7; font-weight: bold;">let</span> <span style="color: #67b11d;">[</span><span style="color: #b1951d;">[</span>head &amp; tail<span style="color: #b1951d;">]</span> coll<span style="color: #67b11d;">]</span>
      <span style="color: #67b11d;">(</span><span style="color: #4f97d7; font-weight: bold;">recur</span>
       rf
       <span style="color: #b1951d;">(</span>rf accum head<span style="color: #b1951d;">)</span>
       tail<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
    accum<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
</code></pre>
</div>

</section>
<section id="slide-org0e51295">
<h3 id="org0e51295">Check for correctness</h3>
<div class="outline-text-3" id="text-org0e51295">
</div>
</section>
<section id="slide-org827e544">
<h4 id="org827e544">Accumulate a number</h4>
<div class="org-src-container">

<pre  class="src src-clojure"   ><code trim><span style="color: #4f97d7;">(</span>-reduce + <span style="color: #a45bad;">0</span> <span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">1</span> <span style="color: #a45bad;">2</span> <span style="color: #a45bad;">3</span> <span style="color: #a45bad;">4</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>
</code></pre>
</div>

<pre class="example">
10
</pre>

</section>
<section id="slide-org9b9a12c">
<h4 id="org9b9a12c">Accumulate a collection</h4>
<div class="org-src-container">

<pre  class="src src-clojure"   ><code trim><span style="color: #4f97d7;">(</span>-reduce conj <span style="color: #bc6ec5;">[]</span> <span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">1</span> <span style="color: #a45bad;">2</span> <span style="color: #a45bad;">3</span> <span style="color: #a45bad;">4</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>
</code></pre>
</div>

<pre class="example">
[1 2 3 4]
</pre>

</section>
<section id="slide-org12589c4">
<h4 id="org12589c4">Accumulate a collection of different type</h4>
<div class="org-src-container">

<pre  class="src src-clojure"   ><code trim><span style="color: #4f97d7;">(</span>-reduce conj <span style="color: #bc6ec5;">()</span> <span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">1</span> <span style="color: #a45bad;">2</span> <span style="color: #a45bad;">3</span> <span style="color: #a45bad;">4</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>
</code></pre>
</div>

<pre class="example">
(4 3 2 1)
</pre>

</section>
<section id="slide-orgb767409">
<h3 id="orgb767409">Implications</h3>
<p>
This implementation has a deep significance:
</p>

<p>
Since we can implement reduce with linear recursion (loop), this
relationship is bi-directional.
</p>

<p>
Everything which can be implemented with one, can also be implemented with the
other.
</p>

<p>
Can you poke holes in this assumption?
</p>

</section>
<section id="slide-orgcd4d7bb">
<h3 id="orgcd4d7bb">Early termination!</h3>
<div class="org-src-container">

<pre  class="src src-clojure"   ><code trim><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">defn</span> <span style="color: #bc6ec5; font-weight: bold;">-reduce</span>
  <span style="color: #bc6ec5;">[</span>rf accum coll<span style="color: #bc6ec5;">]</span>
  <span style="color: #bc6ec5;">(</span><span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>seq coll<span style="color: #2d9574;">)</span>
    <span style="color: #2d9574;">(</span><span style="color: #4f97d7; font-weight: bold;">let</span> <span style="color: #67b11d;">[</span><span style="color: #b1951d;">[</span>head &amp; tail<span style="color: #b1951d;">]</span> coll
          result <span style="color: #b1951d;">(</span>rf accum head<span style="color: #b1951d;">)</span><span style="color: #67b11d;">]</span>
      <span style="color: #67b11d;">(</span><span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #b1951d;">(</span>reduced? result<span style="color: #b1951d;">)</span>
        result
        <span style="color: #b1951d;">(</span><span style="color: #4f97d7; font-weight: bold;">recur</span> rf result tail<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
    accum<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
</code></pre>
</div>

</section>
</section>
<section>
<section id="slide-org6768b31">
<h2 id="org6768b31">Map &amp; Filter</h2>
<p>
Let's now take a side trip to implement map and filter from scratch.
</p>

<p>
We aren't looking for efficiency, just a correct implementation:
</p>

</section>
<section id="slide-orga749c18">
<h3 id="orga749c18">Map</h3>
<div class="outline-text-3" id="text-orga749c18">
</div>
</section>
<section id="slide-orge72b530">
<h4 id="orge72b530">loop implementation</h4>
<div class="org-src-container">

<pre  class="src src-clojure"   ><code trim><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">defn</span> <span style="color: #bc6ec5; font-weight: bold;">-map</span>
  <span style="color: #bc6ec5;">[</span>f coll<span style="color: #bc6ec5;">]</span>
  <span style="color: #bc6ec5;">(</span><span style="color: #4f97d7; font-weight: bold;">loop</span> <span style="color: #2d9574;">[</span>ret <span style="color: #67b11d;">[]</span><span style="color: #2d9574;">]</span>
    <span style="color: #2d9574;">(</span><span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>seq coll<span style="color: #67b11d;">)</span>
      <span style="color: #67b11d;">(</span><span style="color: #4f97d7; font-weight: bold;">let</span> <span style="color: #b1951d;">[</span><span style="color: #4f97d7;">[</span>head &amp; tail<span style="color: #4f97d7;">]</span> coll<span style="color: #b1951d;">]</span>
        <span style="color: #b1951d;">(</span><span style="color: #4f97d7; font-weight: bold;">recur</span>
         <span style="color: #4f97d7;">(</span>conj ret <span style="color: #bc6ec5;">(</span>f head<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
         tail<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
      ret<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>

<span style="color: #4f97d7;">(</span>-map inc <span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">1</span> <span style="color: #a45bad;">2</span> <span style="color: #a45bad;">3</span> <span style="color: #a45bad;">4</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>
</code></pre>
</div>

<pre class="example">
[2 3 4 5]
</pre>

</section>
<section id="slide-org759f6d6">
<h4 id="org759f6d6">reduce conversion</h4>
<p>
Since loop and reduce are equivalent, we can rewrite our map with reduce:
</p>

<div class="org-src-container">

<pre  class="src src-clojure"   ><code trim><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">defn</span> <span style="color: #bc6ec5; font-weight: bold;">-map</span>
  <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">[</span>f coll<span style="color: #2d9574;">]</span>
   <span style="color: #2d9574;">(</span>-map f <span style="color: #67b11d;">[]</span> coll<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>
  <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">[</span>f acc coll<span style="color: #2d9574;">]</span>
   <span style="color: #2d9574;">(</span>-reduce
    <span style="color: #67b11d;">(</span><span style="color: #4f97d7; font-weight: bold;">fn</span> <span style="color: #b1951d;">[</span>accumulator element<span style="color: #b1951d;">]</span>
      <span style="color: #b1951d;">(</span>conj accumulator <span style="color: #4f97d7;">(</span>f element<span style="color: #4f97d7;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
    acc
    coll<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>

<span style="color: #4f97d7;">(</span>-map inc <span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">1</span> <span style="color: #a45bad;">2</span> <span style="color: #a45bad;">3</span> <span style="color: #a45bad;">4</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>
</code></pre>
</div>

<pre class="example">
[2 3 4 5]
</pre>

</section>
<section id="slide-org2221a35">
<h3 id="org2221a35">Recap</h3>
<p>
What is <code>rf</code>? <code>(conj accumulator (f element))</code>
</p>


<div id="orgffebfb8" class="figure">
<p><img src="./map1.png" alt="map1.png" />
</p>
</div>

</section>
<section id="slide-orgeba2c0e">
<h3 id="orgeba2c0e">Filter</h3>
<p>
The same can be done with filter:
</p>

</section>
<section id="slide-orgf9ba412">
<h4 id="orgf9ba412">loop implementation</h4>
<div class="org-src-container">

<pre  class="src src-clojure"   ><code trim><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">defn</span> <span style="color: #bc6ec5; font-weight: bold;">-filter</span>
  <span style="color: #bc6ec5;">[</span>pred coll<span style="color: #bc6ec5;">]</span>
  <span style="color: #bc6ec5;">(</span><span style="color: #4f97d7; font-weight: bold;">loop</span> <span style="color: #2d9574;">[</span>ret <span style="color: #67b11d;">[]</span>
         coll <span style="color: #67b11d;">(</span>seq coll<span style="color: #67b11d;">)</span><span style="color: #2d9574;">]</span>
    <span style="color: #2d9574;">(</span><span style="color: #4f97d7; font-weight: bold;">if</span> coll
      <span style="color: #67b11d;">(</span><span style="color: #4f97d7; font-weight: bold;">let</span> <span style="color: #b1951d;">[</span><span style="color: #4f97d7;">[</span>head &amp; tail<span style="color: #4f97d7;">]</span> coll
            accum <span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pred head<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">(</span>conj ret head<span style="color: #bc6ec5;">)</span> ret<span style="color: #4f97d7;">)</span><span style="color: #b1951d;">]</span>
        <span style="color: #b1951d;">(</span><span style="color: #4f97d7; font-weight: bold;">recur</span> accum
         tail<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
      ret<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>

<span style="color: #4f97d7;">(</span>-filter even? <span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">1</span> <span style="color: #a45bad;">2</span> <span style="color: #a45bad;">3</span> <span style="color: #a45bad;">4</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>
</code></pre>
</div>

<pre class="example">
[2 4]
</pre>

</section>
<section id="slide-org04b9447">
<h4 id="org04b9447">reduce conversion</h4>
<div class="org-src-container">

<pre  class="src src-clojure"   ><code trim><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">defn</span> <span style="color: #bc6ec5; font-weight: bold;">-filter</span>
  <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">[</span>pred coll<span style="color: #2d9574;">]</span>
   <span style="color: #2d9574;">(</span>-filter pred <span style="color: #67b11d;">[]</span> coll<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>
  <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">[</span>pred acc coll<span style="color: #2d9574;">]</span>
   <span style="color: #2d9574;">(</span>-reduce
    <span style="color: #67b11d;">(</span><span style="color: #4f97d7; font-weight: bold;">fn</span> <span style="color: #b1951d;">[</span>accumulator element<span style="color: #b1951d;">]</span>
      <span style="color: #b1951d;">(</span><span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #4f97d7;">(</span>pred element<span style="color: #4f97d7;">)</span>
        <span style="color: #4f97d7;">(</span>conj accumulator element<span style="color: #4f97d7;">)</span>
        accumulator<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
    acc
    coll<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>

<span style="color: #4f97d7;">(</span>-filter even? <span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">1</span> <span style="color: #a45bad;">2</span> <span style="color: #a45bad;">3</span> <span style="color: #a45bad;">4</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>
</code></pre>
</div>

<pre class="example">
[2 4]
</pre>


</section>
</section>
<section>
<section id="slide-orgb33ab47">
<h2 id="orgb33ab47">The invariant</h2>
<p>
There is an important property to reducing processes, recursions and loops,
which is a sort of invariance:
</p>

<p>
there is always one quantity which decreases and one which grows.
</p>

</section>
<section id="slide-orgb33ab47-split">

<h2>The invariant</h2>

<p>
The process ends when the decreasing quantity reaches a "zero" value
</p>

<p>
It returns the accumulated value we have grown instead.
</p>

</section>
<section id="slide-orgb33ab47-split">

<h2>The invariant</h2>

<p>
In <code>reduce</code> it is quite evident:
</p>
<ul>
<li><code>coll</code> decreases</li>
<li><code>acc</code> increases.</li>

</ul>

<p>
These can be numbers or collections, the principle remains the same.
</p>

</section>
<section id="slide-orgb33ab47-split">

<h2>The invariant</h2>

<p>
With both <code>map</code> and <code>reduce</code>, we have also seen:
</p>
<ul>
<li>an accumulator which grows, sometimes conditionally.</li>
<li>a source which shrinks.</li>

</ul>

<p>
This invariant is what will allow us to derive transducers.
</p>

</section>
</section>
<section>
<section id="slide-org0f936df">
<h2 id="org0f936df">Refactor</h2>
<p>
You might have noticed the map and filter implementations with reduce look very
familiar. They are actually the same besides a common core:
</p>

</section>
<section id="slide-org496ed17">
<h3 id="org496ed17">Map's core</h3>
<div class="org-src-container">

<pre  class="src src-clojure"   ><code trim><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">defn</span> <span style="color: #bc6ec5; font-weight: bold;">map-core</span>
  <span style="color: #bc6ec5;">[</span>f<span style="color: #bc6ec5;">]</span>
  <span style="color: #bc6ec5;">(</span><span style="color: #4f97d7; font-weight: bold;">fn</span> <span style="color: #2d9574;">[</span>accumulator element<span style="color: #2d9574;">]</span>
    <span style="color: #2d9574;">(</span>conj accumulator <span style="color: #67b11d;">(</span>f element<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>

<span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">defn</span> <span style="color: #bc6ec5; font-weight: bold;">-map</span>
  <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">[</span>f coll<span style="color: #2d9574;">]</span>
   <span style="color: #2d9574;">(</span>-map f <span style="color: #67b11d;">[]</span> coll<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>
  <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">[</span>f acc coll<span style="color: #2d9574;">]</span>
   <span style="color: #2d9574;">(</span>-reduce <span style="color: #67b11d;">(</span>map-core f<span style="color: #67b11d;">)</span> acc coll<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>

<span style="color: #4f97d7;">(</span>-map inc <span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">1</span> <span style="color: #a45bad;">2</span> <span style="color: #a45bad;">3</span> <span style="color: #a45bad;">4</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>
</code></pre>
</div>

<pre class="example">
[2 3 4 5]
</pre>

</section>
<section id="slide-org0f4629c">
<h3 id="org0f4629c">Recap</h3>

<div id="orgaa62a2e" class="figure">
<p><img src="./map2.png" alt="map2.png" />
</p>
</div>

</section>
<section id="slide-org87f9b92">
<h3 id="org87f9b92">Filter's core</h3>
<div class="org-src-container">

<pre  class="src src-clojure"   ><code trim><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">defn</span> <span style="color: #bc6ec5; font-weight: bold;">filter-core</span>
  <span style="color: #bc6ec5;">[</span>pred<span style="color: #bc6ec5;">]</span>
  <span style="color: #bc6ec5;">(</span><span style="color: #4f97d7; font-weight: bold;">fn</span> <span style="color: #2d9574;">[</span>accumulator element<span style="color: #2d9574;">]</span>
    <span style="color: #2d9574;">(</span><span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>pred element<span style="color: #67b11d;">)</span>
      <span style="color: #67b11d;">(</span>conj accumulator element<span style="color: #67b11d;">)</span>
      accumulator<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>

<span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">defn</span> <span style="color: #bc6ec5; font-weight: bold;">-filter</span>
  <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">[</span>pred coll<span style="color: #2d9574;">]</span>
   <span style="color: #2d9574;">(</span>-filter pred <span style="color: #67b11d;">[]</span> coll<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>
  <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">[</span>pred acc coll<span style="color: #2d9574;">]</span>
   <span style="color: #2d9574;">(</span>-reduce <span style="color: #67b11d;">(</span>filter-core pred<span style="color: #67b11d;">)</span> acc coll<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>

<span style="color: #4f97d7;">(</span>-filter even? <span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">1</span> <span style="color: #a45bad;">2</span> <span style="color: #a45bad;">3</span> <span style="color: #a45bad;">4</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>
</code></pre>
</div>

<pre class="example">
[2 4]
</pre>


</section>
</section>
<section>
<section id="slide-orge1f33ac">
<h2 id="orge1f33ac">Push / Pull</h2>
<p>
Now we have reached at something interesting. The <code>*-core</code> functions we have
extracted are completely agnostic of the notion of taking <code>element</code> out of the
source collection.
</p>

</section>
<section id="slide-orge1f33ac-split">

<h2>Push / Pull</h2>

<p>
We have factored out the process of "consuming" elements completely.
</p>

</section>
<section id="slide-orgf403a49">
<h3 id="orgf403a49">Extracting accumulation</h3>
<p>
Still in our implementation, we have the accumulating function. Can we factor it
out? Let's see what happens:
</p>

</section>
<section id="slide-orgde98d5f">
<h4 id="orgde98d5f">Map</h4>
<div class="org-src-container">

<pre  class="src src-clojure"   ><code trim><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">defn</span> <span style="color: #bc6ec5; font-weight: bold;">map-core</span>
  <span style="color: #bc6ec5;">[</span>f grow<span style="color: #bc6ec5;">]</span>
  <span style="color: #bc6ec5;">(</span><span style="color: #4f97d7; font-weight: bold;">fn</span> <span style="color: #2d9574;">[</span>accumulator element<span style="color: #2d9574;">]</span>
    <span style="color: #2d9574;">(</span>grow accumulator <span style="color: #67b11d;">(</span>f element<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>

<span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">defn</span> <span style="color: #bc6ec5; font-weight: bold;">-map</span>
  <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">[</span>f coll<span style="color: #2d9574;">]</span>
   <span style="color: #2d9574;">(</span>-map f <span style="color: #67b11d;">[]</span> coll<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>
  <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">[</span>f acc coll<span style="color: #2d9574;">]</span>
   <span style="color: #2d9574;">(</span>-reduce <span style="color: #67b11d;">(</span>map-core f conj<span style="color: #67b11d;">)</span> acc coll<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>

<span style="color: #4f97d7;">(</span>-map inc <span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">1</span> <span style="color: #a45bad;">2</span> <span style="color: #a45bad;">3</span> <span style="color: #a45bad;">4</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>
</code></pre>
</div>

<pre class="example">
[2 3 4 5]
</pre>

</section>
<section id="slide-org38908c6">
<h4 id="org38908c6">Recap</h4>

<div id="org58c9726" class="figure">
<p><img src="./map3.png" alt="map3.png" />
</p>
</div>

</section>
<section id="slide-orgd228676">
<h4 id="orgd228676">Map, curried</h4>
<p>
But that's actually a less interesting way of writing it. We can instead return
a closure:
</p>

<div class="org-src-container">

<pre  class="src src-clojure"   ><code trim><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">defn</span> <span style="color: #bc6ec5; font-weight: bold;">map-core</span>
  <span style="color: #bc6ec5;">[</span>f<span style="color: #bc6ec5;">]</span>
  <span style="color: #bc6ec5;">(</span><span style="color: #4f97d7; font-weight: bold;">fn</span> <span style="color: #2d9574;">[</span>grow<span style="color: #2d9574;">]</span>
    <span style="color: #2d9574;">(</span><span style="color: #4f97d7; font-weight: bold;">fn</span> <span style="color: #67b11d;">[</span>accumulator element<span style="color: #67b11d;">]</span>
      <span style="color: #67b11d;">(</span>grow accumulator <span style="color: #b1951d;">(</span>f element<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>

<span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">defn</span> <span style="color: #bc6ec5; font-weight: bold;">-map</span>
  <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">[</span>f coll<span style="color: #2d9574;">]</span>
   <span style="color: #2d9574;">(</span>-map f <span style="color: #67b11d;">[]</span> coll<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>
  <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">[</span>f acc coll<span style="color: #2d9574;">]</span>
   <span style="color: #2d9574;">(</span>-reduce <span style="color: #67b11d;">(</span><span style="color: #b1951d;">(</span>map-core f<span style="color: #b1951d;">)</span> conj<span style="color: #67b11d;">)</span> acc coll<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>

<span style="color: #4f97d7;">(</span>-map inc <span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">1</span> <span style="color: #a45bad;">2</span> <span style="color: #a45bad;">3</span> <span style="color: #a45bad;">4</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>
</code></pre>
</div>

<pre class="example">
[2 3 4 5]
</pre>

</section>
<section id="slide-orga8d5a00">
<h4 id="orga8d5a00">Recap</h4>

<div id="org342279c" class="figure">
<p><img src="./map4.png" alt="map4.png" />
</p>
</div>

</section>
<section id="slide-org1cfba62">
<h4 id="org1cfba62">Filter, curried</h4>
<p>
Similarly for filter:
</p>

<div class="org-src-container">

<pre  class="src src-clojure"   ><code trim><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">defn</span> <span style="color: #bc6ec5; font-weight: bold;">filter-core</span>
  <span style="color: #bc6ec5;">[</span>pred<span style="color: #bc6ec5;">]</span>
  <span style="color: #bc6ec5;">(</span><span style="color: #4f97d7; font-weight: bold;">fn</span> <span style="color: #2d9574;">[</span>grow<span style="color: #2d9574;">]</span>
    <span style="color: #2d9574;">(</span><span style="color: #4f97d7; font-weight: bold;">fn</span> <span style="color: #67b11d;">[</span>accumulator element<span style="color: #67b11d;">]</span>
      <span style="color: #67b11d;">(</span><span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #b1951d;">(</span>pred element<span style="color: #b1951d;">)</span>
        <span style="color: #b1951d;">(</span>grow accumulator element<span style="color: #b1951d;">)</span>
        accumulator<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>

<span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">defn</span> <span style="color: #bc6ec5; font-weight: bold;">-filter</span>
  <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">[</span>pred coll<span style="color: #2d9574;">]</span>
   <span style="color: #2d9574;">(</span>-filter pred <span style="color: #67b11d;">[]</span> coll<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>
  <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">[</span>pred acc coll<span style="color: #2d9574;">]</span>
   <span style="color: #2d9574;">(</span>-reduce <span style="color: #67b11d;">(</span><span style="color: #b1951d;">(</span>filter-core pred<span style="color: #b1951d;">)</span> conj<span style="color: #67b11d;">)</span> acc coll<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>

<span style="color: #4f97d7;">(</span>-filter even? <span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">1</span> <span style="color: #a45bad;">2</span> <span style="color: #a45bad;">3</span> <span style="color: #a45bad;">4</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>
</code></pre>
</div>

<pre class="example">
[2 4]
</pre>


</section>
<section id="slide-org1cfba62-split">

<h4>Filter, curried</h4>

<p>
"Okay", you might say, "this is interesting". But is it useful?
</p>

</section>
</section>
<section>
<section id="slide-org969b284">
<h2 id="org969b284">Reducing Functions</h2>
<p>
In our small refactoring process we derived two higher order functions.
</p>

<p>
While maintaining the reducing process invariant, they are completely independent of
its implementation.
</p>

<p>
On the contrary, they are <i>parametrized</i> on it.
</p>

</section>
<section id="slide-org969b284-split">

<h2>Reducing Functions</h2>

<p>
The consume / pull part of the implementation is handled by <code>reduce</code>.
</p>

<p>
The accumulation / push part is now a parameter, which is a function, <code>grow</code>.
</p>

</section>
<section id="slide-org969b284-split">

<h2>Reducing Functions</h2>

<div class="org-src-container">

<pre  class="src src-clojure"   ><code trim><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">defn</span> <span style="color: #bc6ec5; font-weight: bold;">map-core</span>
  <span style="color: #bc6ec5;">[</span>f<span style="color: #bc6ec5;">]</span>
  <span style="color: #bc6ec5;">(</span><span style="color: #4f97d7; font-weight: bold;">fn</span> <span style="color: #2d9574;">[</span>grow<span style="color: #2d9574;">]</span>
    <span style="color: #2d9574;">(</span><span style="color: #4f97d7; font-weight: bold;">fn</span> <span style="color: #67b11d;">[</span>accumulator element<span style="color: #67b11d;">]</span>
      <span style="color: #67b11d;">(</span>grow accumulator <span style="color: #b1951d;">(</span>f element<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>

<span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">defn</span> <span style="color: #bc6ec5; font-weight: bold;">filter-core</span>
  <span style="color: #bc6ec5;">[</span>pred<span style="color: #bc6ec5;">]</span>
  <span style="color: #bc6ec5;">(</span><span style="color: #4f97d7; font-weight: bold;">fn</span> <span style="color: #2d9574;">[</span>grow<span style="color: #2d9574;">]</span>
    <span style="color: #2d9574;">(</span><span style="color: #4f97d7; font-weight: bold;">fn</span> <span style="color: #67b11d;">[</span>accumulator element<span style="color: #67b11d;">]</span>
      <span style="color: #67b11d;">(</span><span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #b1951d;">(</span>pred element<span style="color: #b1951d;">)</span>
        <span style="color: #b1951d;">(</span>grow accumulator element<span style="color: #b1951d;">)</span>
        accumulator<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
</code></pre>
</div>

</section>
<section id="slide-org3e1eaa6">
<h3 id="org3e1eaa6">Properties of reducing functions</h3>
<p>
What properties should <code>grow</code> have?
</p>

<p>
Such a function, which can be used by reduce, is called a <b>reducing function</b>,
and is usually abbreviated as <code>rf</code> in arguments.
</p>

</section>
<section id="slide-org3d8f8ed">
<h4 id="org3d8f8ed">Step</h4>
<p>
<code>grow</code> is still a function which takes an accumulator and an element, and
returns an "updated" accumulator.
</p>

</section>
<section id="slide-orgbb024c1">
<h4 id="orgbb024c1">Beginning and end</h4>
<p>
It is useful when working with reducers to have a way to signal "beginning" and
"end" of the reducing process.
</p>

</section>
<section id="slide-orgb95e24b">
<h4 id="orgb95e24b">Beginning</h4>
<p>
In the beginning, we can create the initial value into which we will accumulate
(thus the 2-arity of <code>reduce</code> is handled).
</p>

</section>
<section id="slide-orgc231b85">
<h4 id="orgc231b85">End</h4>
<p>
In the end, we sometimes want to "finalize" our accumulator.
For example, we might be using transient collections as an optimization, and in
the end we want to call <code>persistent!</code>.
</p>

</section>
<section id="slide-orgad137c0">
<h4 id="orgad137c0">Generally</h4>
<p>
Therefor, the full signature of a reducing function will be:
</p>

<div class="org-src-container">

<pre  class="src src-clojure"   ><code trim><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">defn</span> <span style="color: #bc6ec5; font-weight: bold;">rf</span>
  <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">[]</span> initial-value<span style="color: #bc6ec5;">)</span>
  <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">[</span>accum<span style="color: #2d9574;">]</span> <span style="color: #2d9574;">(</span>finalize accum<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>
  <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">[</span>accum elem<span style="color: #2d9574;">]</span> <span style="color: #2d9574;">(</span>combine accum elem<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
</code></pre>
</div>

</section>
<section id="slide-orgd57e9df">
<h4 id="orgd57e9df">For example</h4>
<div class="org-src-container">

<pre  class="src src-clojure"   ><code trim><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">defn</span> <span style="color: #bc6ec5; font-weight: bold;">rf</span>
  <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">[]</span> <span style="color: #2d9574;">(</span>transient <span style="color: #67b11d;">[]</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>
  <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">[</span>v<span style="color: #2d9574;">]</span> <span style="color: #2d9574;">(</span>persistent! v<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>
  <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">[</span>v x<span style="color: #2d9574;">]</span> <span style="color: #2d9574;">(</span>conj! v x<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>

<span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">defn</span> <span style="color: #bc6ec5; font-weight: bold;">map-core</span>
  <span style="color: #bc6ec5;">[</span>f<span style="color: #bc6ec5;">]</span>
  <span style="color: #bc6ec5;">(</span><span style="color: #4f97d7; font-weight: bold;">fn</span> <span style="color: #2d9574;">[</span>rf<span style="color: #2d9574;">]</span>
    <span style="color: #2d9574;">(</span><span style="color: #4f97d7; font-weight: bold;">fn</span> <span style="color: #67b11d;">[</span>accumulator element<span style="color: #67b11d;">]</span>
      <span style="color: #67b11d;">(</span>rf accumulator <span style="color: #b1951d;">(</span>f element<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>

<span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">defn</span> <span style="color: #bc6ec5; font-weight: bold;">-map</span>
  <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">[</span>f coll<span style="color: #2d9574;">]</span>
   <span style="color: #2d9574;">(</span>-map f <span style="color: #67b11d;">(</span>rf<span style="color: #67b11d;">)</span> coll<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>
  <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">[</span>f acc coll<span style="color: #2d9574;">]</span>
   <span style="color: #2d9574;">(</span>rf <span style="color: #67b11d;">(</span>-reduce <span style="color: #b1951d;">(</span><span style="color: #4f97d7;">(</span>map-core f<span style="color: #4f97d7;">)</span> rf<span style="color: #b1951d;">)</span> acc coll<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>

<span style="color: #4f97d7;">(</span>-map inc <span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">1</span> <span style="color: #a45bad;">2</span> <span style="color: #a45bad;">3</span> <span style="color: #a45bad;">4</span> <span style="color: #a45bad;">5</span> <span style="color: #a45bad;">6</span> <span style="color: #a45bad;">7</span> <span style="color: #a45bad;">8</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>
</code></pre>
</div>

<pre class="example">
[2 3 4 5 6 7 8 9]
</pre>

</section>
<section id="slide-org4a35952">
<h4 id="org4a35952">Compare</h4>

<div id="orgb6b5f91" class="figure">
<p><img src="./map5.png" alt="map5.png" />
</p>
</div>

</section>
<section id="slide-orgc4a2658">
<h4 id="orgc4a2658">Observation</h4>
<p>
A very important point to now is that after closing over <code>f</code> or <code>pred</code>,
<code>map-core</code> and <code>filter-core</code> respectively return functions which take a reducing
function and return a reducing function.
</p>

</section>
</section>
<section>
<section id="slide-org9dc323f">
<h2 id="org9dc323f">Finally, Transducers</h2>
<p>
It turns out this pattern is so useful it deserves a function of its own,
centered around reduce. Let's invoke the spirit of Tim Allen and move some stuff
around the house first:
</p>

</section>
<section id="slide-orgdf31207">
<h3 id="orgdf31207">Spelling the process out - map</h3>
<div class="org-src-container">

<pre  class="src src-clojure"   ><code trim><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">defn</span> <span style="color: #bc6ec5; font-weight: bold;">-map</span>
  <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">[</span>f coll<span style="color: #2d9574;">]</span>
   <span style="color: #2d9574;">(</span>-map f <span style="color: #67b11d;">(</span>rf<span style="color: #67b11d;">)</span> coll<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>
  <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">[</span>f acc coll<span style="color: #2d9574;">]</span>
   <span style="color: #2d9574;">(</span><span style="color: #4f97d7; font-weight: bold;">let</span> <span style="color: #67b11d;">[</span>?f <span style="color: #b1951d;">(</span>map-core f<span style="color: #b1951d;">)</span>
         rf' <span style="color: #b1951d;">(</span>?f rf<span style="color: #b1951d;">)</span>
         ret <span style="color: #b1951d;">(</span>-reduce rf' acc coll<span style="color: #b1951d;">)</span><span style="color: #67b11d;">]</span>
     <span style="color: #67b11d;">(</span>rf ret<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
</code></pre>
</div>

</section>
<section id="slide-org160722d">
<h4 id="org160722d">Compare</h4>

<div id="orga2033a7" class="figure">
<p><img src="./map6.png" alt="map6.png" />
</p>
</div>

</section>
<section id="slide-org31539ac">
<h3 id="org31539ac">A wild transduce appears</h3>
<p>
Now the process almost jumps out at us:
</p>

<div class="org-src-container">

<pre  class="src src-clojure"   ><code trim><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">defn</span> <span style="color: #bc6ec5; font-weight: bold;">-transduce</span>
  <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">[</span>rf ?f coll<span style="color: #2d9574;">]</span>
   <span style="color: #2d9574;">(</span>-transduce rf ?f <span style="color: #67b11d;">(</span>rf<span style="color: #67b11d;">)</span> coll<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>
  <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">[</span>rf ?f acc coll<span style="color: #2d9574;">]</span>
   <span style="color: #2d9574;">(</span><span style="color: #4f97d7; font-weight: bold;">let</span> <span style="color: #67b11d;">[</span>rf' <span style="color: #b1951d;">(</span>?f rf<span style="color: #b1951d;">)</span>
         ret <span style="color: #b1951d;">(</span>-reduce rf' acc coll<span style="color: #b1951d;">)</span><span style="color: #67b11d;">]</span>
     <span style="color: #67b11d;">(</span>rf ret<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>

<span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">defn</span> <span style="color: #bc6ec5; font-weight: bold;">-map</span>
  <span style="color: #bc6ec5;">[</span>f coll<span style="color: #bc6ec5;">]</span>
  <span style="color: #bc6ec5;">(</span>-transduce rf <span style="color: #2d9574;">(</span>map-core f<span style="color: #2d9574;">)</span> coll<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>

<span style="color: #4f97d7;">(</span>-map inc <span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">1</span> <span style="color: #a45bad;">2</span> <span style="color: #a45bad;">3</span> <span style="color: #a45bad;">4</span> <span style="color: #a45bad;">5</span> <span style="color: #a45bad;">6</span> <span style="color: #a45bad;">7</span> <span style="color: #a45bad;">8</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>
</code></pre>
</div>

<pre class="example">
[2 3 4 5 6 7 8 9]
</pre>

</section>
<section id="slide-org070fd49">
<h4 id="org070fd49">Compare</h4>

<div id="orge7d75d3" class="figure">
<p><img src="./map7.png" alt="map7.png" />
</p>
</div>

</section>
<section id="slide-orgd5102fa">
<h4 id="orgd5102fa"><code>clojre.core/transduce</code></h4>
<ul>
<li><code>[xform f init coll]</code></li>
<li>reduce with a transformation of f (xf)</li>
<li>If init is not supplied, (f) will be called to produce it</li>
<li>f should be a reducing step function that accepts both 1 and 2 arguments</li>
<li>Returns the result of applying (the transformed) xf to init and the
first item in coll, then applying xf to that result and the 2nd item,
etc.</li>

</ul>

</section>
<section id="slide-orgbc59153">
<h4 id="orgbc59153">The missing piece</h4>
<p>
Hopefully, everything about what we did is clear besides <code>?f</code>. What is it? what
does it do?
</p>

</section>
<section id="slide-org8c0ab64">
<h4 id="org8c0ab64">Transforming a reducing function</h4>
<p>
Like we mentioned in the end of the previous section, <code>?f</code> takes a reducing
function <code>rf</code> and returns another valid reducing function.
</p>

</section>
<section id="slide-org8c0ab64-split">

<h4>Transforming a reducing function</h4>

<p>
In other words, it <i>transforms</i> a reducing function, by wrapping it. In Clojure,
such functions are called <i>transducers</i> as they transform reducers.
</p>

</section>
<section id="slide-org8c0ab64-split">

<h4>Transforming a reducing function</h4>

<p>
Conventionally, transducers are labeled <code>xf</code> or <code>xform</code>.
</p>

</section>
</section>
<section>
<section id="slide-org81e5b6d">
<h2 id="org81e5b6d">Transducers as Transformations</h2>
<p>
What are the implications of having a function which transforms a reducing
function?
</p>

<p>
<code>xf :: rf -&gt; rf'</code>
</p>

<p>
These transformations compose!
</p>

</section>
<section id="slide-orgf1053d6">
<h3 id="orgf1053d6">Composing transducers</h3>
<pre  class="example" >
xf :: rf -&gt; rf'
xf' :: rf' -&gt; rf''
xf o xf' :: rf -&gt; rf''
</pre>

</section>
<section id="slide-orgf17e932">
<h3 id="orgf17e932">Order of application</h3>
<p>
The order of transformation matters, and the last transformation will be the
<i>first applied</i>, i.e.
</p>

<div class="org-src-container">

<pre  class="src src-clojure"   ><code trim><span style="color: #4f97d7;">(</span>comp
 <span style="color: #bc6ec5;">(</span>map inc<span style="color: #bc6ec5;">)</span>
 <span style="color: #bc6ec5;">(</span>filter even?<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
</code></pre>
</div>

</section>
<section id="slide-org64b467f">
<h3 id="org64b467f">Substitution</h3>
<p>
Remember this transducer is applied to a reducing function. By way of substitution:
</p>
<div class="org-src-container">

<pre  class="src src-clojure"   ><code trim><span style="color: #4f97d7;">(</span><span style="color: #bc6ec5;">(</span>comp
  <span style="color: #2d9574;">(</span>map inc<span style="color: #2d9574;">)</span>
  <span style="color: #2d9574;">(</span>filter even?<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>
 rf<span style="color: #4f97d7;">)</span>

<span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">comp</span>
<span style="color: #4f97d7;">(</span><span style="color: #bc6ec5;">(</span>map inc<span style="color: #bc6ec5;">)</span>
 <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>filter even?<span style="color: #2d9574;">)</span>
  rf<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
</code></pre>
</div>

</section>
<section id="slide-orga551845">
<h4 id="orga551845">Substitute filter definition</h4>
<div class="org-src-container">

<pre  class="src src-clojure"   ><code trim><span style="color: #4f97d7;">(</span><span style="color: #bc6ec5;">(</span>map inc<span style="color: #bc6ec5;">)</span>
 <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>filter even?<span style="color: #2d9574;">)</span>
  rf<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>

<span style="color: #4f97d7;">(</span><span style="color: #bc6ec5;">(</span>map inc<span style="color: #bc6ec5;">)</span>
 <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span><span style="color: #4f97d7; font-weight: bold;">fn</span> <span style="color: #67b11d;">[</span>rf'<span style="color: #67b11d;">]</span>
    <span style="color: #67b11d;">(</span><span style="color: #4f97d7; font-weight: bold;">fn</span> <span style="color: #b1951d;">[</span>acc x<span style="color: #b1951d;">]</span>
      <span style="color: #b1951d;">(</span><span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #4f97d7;">(</span>even? x<span style="color: #4f97d7;">)</span>
        <span style="color: #4f97d7;">(</span>rf acc x<span style="color: #4f97d7;">)</span>
        x<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> rf<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
</code></pre>
</div>

</section>
<section id="slide-org22bb564">
<h4 id="org22bb564">Apply inner filter to rf, substitute rf' with rf</h4>
<div class="org-src-container">

<pre  class="src src-clojure"   ><code trim><span style="color: #4f97d7;">(</span><span style="color: #bc6ec5;">(</span>map inc<span style="color: #bc6ec5;">)</span>
 <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span><span style="color: #4f97d7; font-weight: bold;">fn</span> <span style="color: #67b11d;">[</span>rf'<span style="color: #67b11d;">]</span>
    <span style="color: #67b11d;">(</span><span style="color: #4f97d7; font-weight: bold;">fn</span> <span style="color: #b1951d;">[</span>acc x<span style="color: #b1951d;">]</span>
      <span style="color: #b1951d;">(</span><span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #4f97d7;">(</span>even? x<span style="color: #4f97d7;">)</span>
        <span style="color: #4f97d7;">(</span>rf acc x<span style="color: #4f97d7;">)</span>
        x<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> rf<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>

<span style="color: #4f97d7;">(</span><span style="color: #bc6ec5;">(</span>map inc<span style="color: #bc6ec5;">)</span>
 <span style="color: #bc6ec5;">(</span><span style="color: #4f97d7; font-weight: bold;">fn</span> <span style="color: #2d9574;">[</span>acc x<span style="color: #2d9574;">]</span>
   <span style="color: #2d9574;">(</span><span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>even? x<span style="color: #67b11d;">)</span>
     <span style="color: #67b11d;">(</span>rf acc x<span style="color: #67b11d;">)</span>
     x<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
</code></pre>
</div>

</section>
<section id="slide-org79fd4e1">
<h4 id="org79fd4e1">Substitute map definition</h4>
<div class="org-src-container">

<pre  class="src src-clojure"   ><code trim><span style="color: #4f97d7;">(</span><span style="color: #bc6ec5;">(</span>map inc<span style="color: #bc6ec5;">)</span>
 <span style="color: #bc6ec5;">(</span><span style="color: #4f97d7; font-weight: bold;">fn</span> <span style="color: #2d9574;">[</span>acc x<span style="color: #2d9574;">]</span>
   <span style="color: #2d9574;">(</span><span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>even? x<span style="color: #67b11d;">)</span>
     <span style="color: #67b11d;">(</span>rf acc x<span style="color: #67b11d;">)</span>
     x<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>

<span style="color: #4f97d7;">(</span><span style="color: #bc6ec5;">(</span><span style="color: #4f97d7; font-weight: bold;">fn</span> <span style="color: #2d9574;">[</span>rf<span style="color: #2d9574;">]</span>
   <span style="color: #2d9574;">(</span><span style="color: #4f97d7; font-weight: bold;">fn</span> <span style="color: #67b11d;">[</span>acc x<span style="color: #67b11d;">]</span>
     <span style="color: #67b11d;">(</span>rf acc <span style="color: #b1951d;">(</span>inc x<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>
 <span style="color: #bc6ec5;">(</span><span style="color: #4f97d7; font-weight: bold;">fn</span> <span style="color: #2d9574;">[</span>acc x<span style="color: #2d9574;">]</span>
   <span style="color: #2d9574;">(</span><span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>even? x<span style="color: #67b11d;">)</span>
     <span style="color: #67b11d;">(</span>rf acc x<span style="color: #67b11d;">)</span>
     x<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
</code></pre>
</div>

</section>
<section id="slide-orgf426583">
<h4 id="orgf426583">Apply map xf to result, substitute rf</h4>
<div class="org-src-container">

<pre  class="src src-clojure"   ><code trim><span style="color: #4f97d7;">(</span><span style="color: #bc6ec5;">(</span><span style="color: #4f97d7; font-weight: bold;">fn</span> <span style="color: #2d9574;">[</span>rf<span style="color: #2d9574;">]</span>
   <span style="color: #2d9574;">(</span><span style="color: #4f97d7; font-weight: bold;">fn</span> <span style="color: #67b11d;">[</span>acc x<span style="color: #67b11d;">]</span>
     <span style="color: #67b11d;">(</span>rf acc <span style="color: #b1951d;">(</span>inc x<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>
 <span style="color: #bc6ec5;">(</span><span style="color: #4f97d7; font-weight: bold;">fn</span> <span style="color: #2d9574;">[</span>acc x<span style="color: #2d9574;">]</span>
   <span style="color: #2d9574;">(</span><span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>even? x<span style="color: #67b11d;">)</span>
     <span style="color: #67b11d;">(</span>rf acc x<span style="color: #67b11d;">)</span>
     x<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>

<span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">fn</span> <span style="color: #bc6ec5;">[</span>acc x<span style="color: #bc6ec5;">]</span>
  <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span><span style="color: #4f97d7; font-weight: bold;">fn</span> <span style="color: #67b11d;">[</span>acc x<span style="color: #67b11d;">]</span>
     <span style="color: #67b11d;">(</span><span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #b1951d;">(</span>even? x<span style="color: #b1951d;">)</span>
       <span style="color: #b1951d;">(</span>rf acc x<span style="color: #b1951d;">)</span>
       x<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
   acc
   <span style="color: #2d9574;">(</span>inc x<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
</code></pre>
</div>

</section>
<section id="slide-org7c50b25">
<h4 id="org7c50b25">Format</h4>
<div class="org-src-container">

<pre  class="src src-clojure"   ><code trim><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">fn</span> <span style="color: #bc6ec5;">[</span>acc x<span style="color: #bc6ec5;">]</span>
  <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span><span style="color: #4f97d7; font-weight: bold;">fn</span> <span style="color: #67b11d;">[</span>acc x<span style="color: #67b11d;">]</span>
     <span style="color: #67b11d;">(</span><span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #b1951d;">(</span>even? x<span style="color: #b1951d;">)</span>
       <span style="color: #b1951d;">(</span>rf acc x<span style="color: #b1951d;">)</span>
       x<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
   acc
   <span style="color: #2d9574;">(</span>inc x<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>

<span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">fn</span> <span style="color: #bc6ec5;">[</span>acc x<span style="color: #bc6ec5;">]</span>
  <span style="color: #bc6ec5;">(</span><span style="color: #4f97d7; font-weight: bold;">let</span> <span style="color: #2d9574;">[</span>inner <span style="color: #67b11d;">(</span><span style="color: #4f97d7; font-weight: bold;">fn</span> <span style="color: #b1951d;">[</span>acc x<span style="color: #b1951d;">]</span>
                <span style="color: #b1951d;">(</span><span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #4f97d7;">(</span>even? x<span style="color: #4f97d7;">)</span>
                  <span style="color: #4f97d7;">(</span>rf acc x<span style="color: #4f97d7;">)</span>
                  x<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">]</span>
    <span style="color: #2d9574;">(</span>inner acc <span style="color: #67b11d;">(</span>inc x<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
</code></pre>
</div>

<p>
<code>inner</code> (i.e. <code>even?</code>) is called <b>after</b> <code>inc</code>
</p>

<p>
For each x, notice how it will first be mapped on before even passing to
the inner <code>rf</code> which will check <code>even?</code>
</p>

</section>
<section id="slide-orgbcead08">
<h3 id="orgbcead08">Analogue to sequence transformation</h3>
<p>
It might be confusing at first, but transducers apply in an opposite
order to <code>comp</code>.
</p>

<p>
Their application more closely resembles:
</p>

<div class="org-src-container">

<pre  class="src src-clojure"   ><code trim><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">-&gt;&gt;</span> xs
     <span style="color: #bc6ec5;">(</span>map inc<span style="color: #bc6ec5;">)</span>
     <span style="color: #bc6ec5;">(</span>filter even?<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
</code></pre>
</div>

</section>
<section id="slide-org956b833">
<h4 id="org956b833">Transformations are like wraps (but not a burrito)</h4>
<p>
Each transducer is a transformation which returns a function wrapping a
reducing function
</p>

<p>
Every value which passes <i>through</i> the resulting function will pass
through the wrapping layers one by one.
</p>

</section>
<section id="slide-org956b833-split">

<h4>Transformations are like wraps (but not a burrito)</h4>

<p>
The <i>last</i> wrap is the one a value will pass through <i>first</i>.
</p>

<p>
Transducers give us composable transformation pipeline elements.
</p>

</section>
</section>
<section>
<section id="slide-org041ba0e">
<h2 id="org041ba0e">Transducers as Processes</h2>
<p>
Transducers abstract away the source of inputs and accumulation of
results. What's left is a distillation of computational process.
</p>

</section>
<section id="slide-org041ba0e-split">

<h2>Transducers as Processes</h2>

<p>
Now that we have extracted the <i>concept</i> of mapping, we can apply it to
anything which is reducible.
</p>

</section>
<section id="slide-org041ba0e-split">

<h2>Transducers as Processes</h2>

<p>
As reduce is defined with protocols, we can extend this application to
many things.
</p>

</section>
<section id="slide-org72aaa87">
<h3 id="org72aaa87">core.async</h3>
<p>
Channels and sequences have a lot in common. But channels aren't
sequences. By implementing reduce, however, we can gain all the
semantics of transducers with channels "for free":
</p>

<div class="org-src-container">

<pre  class="src src-clojure"   ><code trim><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">async</span>/reduce f init ch<span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">async</span>/transduce xform f init ch<span style="color: #4f97d7;">)</span>
</code></pre>
</div>

</section>
<section id="slide-org9ae537e">
<h4 id="org9ae537e">Channels themselves</h4>
<div class="org-src-container">

<pre  class="src src-clojure"   ><code trim><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">async</span>/chan n xf<span style="color: #4f97d7;">)</span>
</code></pre>
</div>

<p>
Even putting on a channel is a reducing function, thus, channels'
behavior as accumulators can be tweaked.
</p>

<p>
Then, an equivalent to <code>into</code> with a transducer will be
</p>

<div class="org-src-container">

<pre  class="src src-clojure"   ><code trim><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">async</span>/onto-chan! ch coll<span style="color: #4f97d7;">)</span>
</code></pre>
</div>

<p>
Where <code>ch</code> has an attached transducer.
</p>

</section>
<section id="slide-org09636f5">
<h4 id="org09636f5">With concurrency</h4>
<p>
In cases where our transducers are stateless, calculations over sequence
elements could be performed concurrently:
</p>

<div class="org-src-container">

<pre  class="src src-clojure"   ><code trim><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">async</span>/pipeline to n xf from<span style="color: #4f97d7;">)</span>
</code></pre>
</div>

</section>
<section id="slide-org83e0c40">
<h3 id="org83e0c40">Extending transducers</h3>
<p>
Can we apply it to other things?
</p>

</section>
<section id="slide-org9dcc1bb">
<h4 id="org9dcc1bb">Completable Future</h4>
<div class="org-src-container">

<pre  class="src src-clojure"   ><code trim><span style="color: #4f97d7;">(</span>import 'java.util.concurrent.CompletableFuture<span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7;">(</span>import 'java.util.function.Function<span style="color: #4f97d7;">)</span>

<span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">defn</span> <span style="color: #bc6ec5; font-weight: bold;">then</span>
  <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">[</span><span style="color: #b2b2b2; background-color: #292b2e;">^</span><span style="color: #ce537a; font-weight: bold;">CompletableFuture</span> cf f<span style="color: #2d9574;">]</span>
   <span style="color: #2d9574;">(</span>.thenApply cf <span style="color: #67b11d;">(</span>reify Function <span style="color: #b1951d;">(</span>apply <span style="color: #4f97d7;">[</span>_ x<span style="color: #4f97d7;">]</span> <span style="color: #4f97d7;">(</span>f x<span style="color: #4f97d7;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>
  <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">[</span><span style="color: #b2b2b2; background-color: #292b2e;">^</span><span style="color: #ce537a; font-weight: bold;">CompletableFuture</span> cf f v<span style="color: #2d9574;">]</span>
   <span style="color: #2d9574;">(</span>.thenApply cf <span style="color: #67b11d;">(</span>reify Function <span style="color: #b1951d;">(</span>apply <span style="color: #4f97d7;">[</span>_ x<span style="color: #4f97d7;">]</span> <span style="color: #4f97d7;">(</span>f v x<span style="color: #4f97d7;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>

<span style="color: #4f97d7;">(</span>.get <span style="color: #bc6ec5;">(</span>then <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">CompletableFuture</span>/completedFuture <span style="color: #a45bad;">1</span><span style="color: #2d9574;">)</span> inc<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
<span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">=&gt; 2</span>
</code></pre>
</div>

</section>
<section id="slide-org961dabe">
<h4 id="org961dabe">Extend the reduce protocol</h4>
<div class="org-src-container">

<pre  class="src src-clojure"   ><code trim><span style="color: #4f97d7;">(</span>require 'clojure.core.protocols<span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7;">(</span>extend-protocol <span style="color: #ce537a; font-weight: bold;">clojure.core.protocols</span>/CollReduce
  CompletableFuture
  <span style="color: #bc6ec5;">(</span>coll-reduce
    <span style="color: #2d9574;">(</span><span style="color: #67b11d;">[</span>cf f val<span style="color: #67b11d;">]</span> <span style="color: #67b11d;">(</span>then cf f val<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>

<span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">defn</span> <span style="color: #bc6ec5; font-weight: bold;">step</span>
  <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">[]</span> <span style="color: #a45bad;">nil</span><span style="color: #bc6ec5;">)</span>
  <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">[</span><span style="color: #b2b2b2; background-color: #292b2e;">^</span><span style="color: #ce537a; font-weight: bold;">CompletableFuture</span> x<span style="color: #2d9574;">]</span> <span style="color: #2d9574;">(</span>.get x<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>
  <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">[</span>_ x<span style="color: #2d9574;">]</span> x<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
</code></pre>
</div>

</section>
<section id="slide-org076df25">
<h4 id="org076df25">Magic?</h4>
<div class="org-src-container">

<pre  class="src src-clojure"   ><code trim><span style="color: #4f97d7;">(</span>transduce
 <span style="color: #bc6ec5;">(</span>comp
  <span style="color: #2d9574;">(</span>map inc<span style="color: #2d9574;">)</span>
  <span style="color: #2d9574;">(</span>map #<span style="color: #67b11d;">(</span>* <span style="color: #7590db;">%</span> <span style="color: #7590db;">%</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>
 step
 <span style="color: #bc6ec5;">(</span><span style="color: #ce537a; font-weight: bold;">CompletableFuture</span>/completedFuture <span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
<span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">=&gt; 4</span>
</code></pre>
</div>

<p>
We've yet to scratch the surface of the possibilities.
</p>

</section>
</section>
<section>
<section id="slide-org3580dff">
<h2 id="org3580dff">Stateful Transducers</h2>
<p>
Another use case in transducers is keeping state between iterations.
</p>

<p>
While with loops we could just add another binding, with transducers we
often have to close over a mutable value.
</p>

</section>
<section id="slide-org6d8acf5">
<h3 id="org6d8acf5">map-indexed</h3>
<p>
Let's try to implement map-indexed.
</p>

<p>
We know it should be similar to map, but an index should be laying
around, somewhere:
</p>

</section>
<section id="slide-org6f6d3a8">
<h4 id="org6f6d3a8">Volatile</h4>
<p>
Clojure doesn't have mutable state, but it does have managed reference
types.
</p>

<p>
We can use <code>volatile</code> to create a reference with volatile semantics
which can be mutated using <code>vswap!</code>.
</p>

<div class="org-src-container">

<pre  class="src src-clojure"   ><code trim><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #7590db;">v</span> <span style="color: #bc6ec5;">(</span>volatile! <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
@v <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">=&gt; 0</span>
<span style="color: #4f97d7;">(</span>vswap! v inc<span style="color: #4f97d7;">)</span> <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">=&gt; 1</span>
@v <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">=&gt; 1</span>
</code></pre>
</div>

</section>
<section id="slide-orgd523c47">
<h4 id="orgd523c47">Volatile</h4>
<p>
A little helper, because we'll want the previous value:
</p>

<div class="org-src-container">

<pre  class="src src-clojure"   ><code trim><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">defmacro</span> <span style="color: #bc6ec5; font-weight: bold;">vswap-val!</span>
  <span style="color: #9f8766;">"Like vswap! but returns the old value."</span>
  <span style="color: #bc6ec5;">[</span>v &amp; args<span style="color: #bc6ec5;">]</span>
  `<span style="color: #bc6ec5;">(</span><span style="color: #4f97d7; font-weight: bold;">let</span> <span style="color: #2d9574;">[</span>old# @~v<span style="color: #2d9574;">]</span>
     <span style="color: #2d9574;">(</span>vswap! ~v ~@args<span style="color: #2d9574;">)</span>
     old#<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
</code></pre>
</div>

</section>
<section id="slide-orgd523c47-split">

<h4>Volatile</h4>

<div class="org-src-container">

<pre  class="src src-clojure"   ><code trim><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">defn</span> <span style="color: #bc6ec5; font-weight: bold;">-map-indexd</span>
  <span style="color: #bc6ec5;">[</span>f<span style="color: #bc6ec5;">]</span>
  <span style="color: #bc6ec5;">(</span><span style="color: #4f97d7; font-weight: bold;">fn</span> <span style="color: #2d9574;">[</span>rf<span style="color: #2d9574;">]</span>
    <span style="color: #2d9574;">(</span><span style="color: #4f97d7; font-weight: bold;">let</span> <span style="color: #67b11d;">[</span>i <span style="color: #b1951d;">(</span>volatile! <span style="color: #a45bad;">0</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">]</span>
      <span style="color: #67b11d;">(</span><span style="color: #4f97d7; font-weight: bold;">fn</span>
        <span style="color: #b1951d;">(</span><span style="color: #4f97d7;">[]</span> <span style="color: #4f97d7;">(</span>rf<span style="color: #4f97d7;">)</span><span style="color: #b1951d;">)</span>
        <span style="color: #b1951d;">(</span><span style="color: #4f97d7;">[</span>acc<span style="color: #4f97d7;">]</span> <span style="color: #4f97d7;">(</span>rf acc<span style="color: #4f97d7;">)</span><span style="color: #b1951d;">)</span>
        <span style="color: #b1951d;">(</span><span style="color: #4f97d7;">[</span>acc x<span style="color: #4f97d7;">]</span>
         <span style="color: #4f97d7;">(</span>rf acc <span style="color: #bc6ec5;">(</span>f <span style="color: #2d9574;">(</span>vswap-val! i inc<span style="color: #2d9574;">)</span> x<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>

<span style="color: #4f97d7;">(</span>sequence <span style="color: #bc6ec5;">(</span>-map-indexd vector<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">:a</span> <span style="color: #a45bad;">:b</span> <span style="color: #a45bad;">:c</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>
</code></pre>
</div>

<pre class="example">
([0 :a] [1 :b] [2 :c])
</pre>

</section>
<section id="slide-org23ee2e8">
<h4 id="org23ee2e8">Custom type</h4>
<p>
Mutable counter, implements <code>invoke</code>, which mutates the member <code>i</code>
</p>

<div class="org-src-container">

<pre  class="src src-clojure"   ><code trim><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">deftype</span> <span style="color: #ce537a; font-weight: bold;">Counter</span> <span style="color: #bc6ec5;">[</span><span style="color: #b2b2b2; background-color: #292b2e;">^</span><span style="color: #ce537a; font-weight: bold;">int</span> ^<span style="color: #a45bad;">:unsynchronized-mutable</span> i<span style="color: #bc6ec5;">]</span>
  clojure.lang.IFn
  <span style="color: #bc6ec5;">(</span>invoke <span style="color: #2d9574;">[</span>_<span style="color: #2d9574;">]</span>
    <span style="color: #2d9574;">(</span><span style="color: #4f97d7; font-weight: bold;">let</span> <span style="color: #67b11d;">[</span>i' i<span style="color: #67b11d;">]</span>
      <span style="color: #67b11d;">(</span><span style="color: #4f97d7; font-weight: bold;">set!</span> i <span style="color: #b1951d;">(</span>unchecked-inc-int i<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
      i'<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>

<span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #7590db;">c</span> <span style="color: #bc6ec5;">(</span>Counter. <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7;">(</span>.i c<span style="color: #4f97d7;">)</span> <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">=&gt; 0</span>
<span style="color: #4f97d7;">(</span>c<span style="color: #4f97d7;">)</span> <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">=&gt; 0 returns previous value, increments counter</span>
<span style="color: #4f97d7;">(</span>.i c<span style="color: #4f97d7;">)</span> <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">=&gt; 1</span>
</code></pre>
</div>

</section>
<section id="slide-org23ee2e8-split">

<h4>Custom type</h4>

<div class="org-src-container">

<pre  class="src src-clojure"   ><code trim><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">defn</span> <span style="color: #bc6ec5; font-weight: bold;">-map-indexd</span>
  <span style="color: #bc6ec5;">[</span>f<span style="color: #bc6ec5;">]</span>
  <span style="color: #bc6ec5;">(</span><span style="color: #4f97d7; font-weight: bold;">fn</span> <span style="color: #2d9574;">[</span>rf<span style="color: #2d9574;">]</span>
    <span style="color: #2d9574;">(</span><span style="color: #4f97d7; font-weight: bold;">let</span> <span style="color: #67b11d;">[</span>i <span style="color: #b1951d;">(</span>Counter. <span style="color: #a45bad;">0</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">]</span>
      <span style="color: #67b11d;">(</span><span style="color: #4f97d7; font-weight: bold;">fn</span>
        <span style="color: #b1951d;">(</span><span style="color: #4f97d7;">[]</span> <span style="color: #4f97d7;">(</span>rf<span style="color: #4f97d7;">)</span><span style="color: #b1951d;">)</span>
        <span style="color: #b1951d;">(</span><span style="color: #4f97d7;">[</span>acc<span style="color: #4f97d7;">]</span> <span style="color: #4f97d7;">(</span>rf acc<span style="color: #4f97d7;">)</span><span style="color: #b1951d;">)</span>
        <span style="color: #b1951d;">(</span><span style="color: #4f97d7;">[</span>acc x<span style="color: #4f97d7;">]</span>
         <span style="color: #4f97d7;">(</span>rf acc <span style="color: #bc6ec5;">(</span>f <span style="color: #2d9574;">(</span>i<span style="color: #2d9574;">)</span> x<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>

<span style="color: #4f97d7;">(</span>sequence <span style="color: #bc6ec5;">(</span>-map-indexd vector<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">:a</span> <span style="color: #a45bad;">:b</span> <span style="color: #a45bad;">:c</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>
</code></pre>
</div>

<pre class="example">
([0 :a] [1 :b] [2 :c])
</pre>

</section>
<section id="slide-org6cadb62">
<h3 id="org6cadb62">Sliding window</h3>
<p>
Other types of state can also be maintained.
</p>

<p>
For example, holding references to multiple elements, which lets us
implement operations like windowing.
</p>

<p>
Let's reach for a Queue implementation which has the methods add,
remove, size
</p>

</section>
<section id="slide-org6cadb62-split">

<h3>Sliding window</h3>

<div class="org-src-container">

<pre  class="src src-clojure"   ><code trim><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">defn</span> <span style="color: #bc6ec5; font-weight: bold;">sliding</span>
  <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">[</span><span style="color: #b2b2b2; background-color: #292b2e;">^</span><span style="color: #ce537a; font-weight: bold;">long</span> n<span style="color: #2d9574;">]</span> <span style="color: #2d9574;">(</span>sliding n <span style="color: #a45bad;">1</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>
  <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">[</span><span style="color: #b2b2b2; background-color: #292b2e;">^</span><span style="color: #ce537a; font-weight: bold;">long</span> n <span style="color: #b2b2b2; background-color: #292b2e;">^</span><span style="color: #ce537a; font-weight: bold;">long</span> step<span style="color: #2d9574;">]</span>
   <span style="color: #2d9574;">(</span><span style="color: #4f97d7; font-weight: bold;">fn</span> <span style="color: #67b11d;">[</span>rf<span style="color: #67b11d;">]</span>
     <span style="color: #67b11d;">(</span><span style="color: #4f97d7; font-weight: bold;">let</span> <span style="color: #b1951d;">[</span>a <span style="color: #4f97d7;">(</span>java.util.ArrayDeque. n<span style="color: #4f97d7;">)</span><span style="color: #b1951d;">]</span> <span style="color: #2aa1ae; background-color: #292e34;">; Queue instance</span>
       <span style="color: #b1951d;">(</span><span style="color: #4f97d7; font-weight: bold;">fn</span> <span style="color: #4f97d7;">(</span><span style="color: #bc6ec5;">[]</span> <span style="color: #bc6ec5;">(</span>rf<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
         <span style="color: #4f97d7;">(</span><span style="color: #bc6ec5;">[</span>result<span style="color: #bc6ec5;">]</span> <span style="color: #bc6ec5;">(</span>rf result<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span> <span style="color: #2aa1ae; background-color: #292e34;">; don't need leftovers</span>
         <span style="color: #4f97d7;">(</span><span style="color: #bc6ec5;">[</span>result input<span style="color: #bc6ec5;">]</span>
          <span style="color: #bc6ec5;">(</span>.add a input<span style="color: #bc6ec5;">)</span>
          <span style="color: #bc6ec5;">(</span><span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>= n <span style="color: #9cb6ad;">(</span>.size a<span style="color: #9cb6ad;">)</span><span style="color: #2d9574;">)</span>
            <span style="color: #2d9574;">(</span><span style="color: #4f97d7; font-weight: bold;">let</span> <span style="color: #9cb6ad;">[</span>v <span style="color: #4f97d7;">(</span>vec <span style="color: #bc6ec5;">(</span>.toArray a<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span><span style="color: #9cb6ad;">]</span> <span style="color: #2aa1ae; background-color: #292e34;">;copies the collection</span>
              <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">Remove `</span><span style="color: #a45bad; background-color: #292e34;">step</span><span style="color: #2aa1ae; background-color: #292e34;">` elements safely, v is a copy</span>
              <span style="color: #9cb6ad;">(</span><span style="color: #4f97d7; font-weight: bold;">dotimes</span> <span style="color: #4f97d7;">[</span>_ step<span style="color: #4f97d7;">]</span> <span style="color: #4f97d7;">(</span>.removeFirst a<span style="color: #4f97d7;">)</span><span style="color: #9cb6ad;">)</span>
              <span style="color: #9cb6ad;">(</span>rf result v<span style="color: #9cb6ad;">)</span><span style="color: #2d9574;">)</span>
            result<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>

<span style="color: #4f97d7;">(</span>sequence <span style="color: #bc6ec5;">(</span>sliding <span style="color: #a45bad;">3</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">(</span>range <span style="color: #a45bad;">10</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
</code></pre>
</div>

<pre class="example">
([0 1 2] [1 2 3] [2 3 4] [3 4 5] [4 5 6] [5 6 7] [6 7 8] [7 8 9])
</pre>


</section>
</section>
<section>
<section id="slide-org0216f86">
<h2 id="org0216f86">Using transducers</h2>
<div class="outline-text-2" id="text-org0216f86">
</div>
</section>
<section id="slide-org83c5a1f">
<h3 id="org83c5a1f">Transduce</h3>
<p>
Like we have derived previously, <code>transduce</code> is a general API which
decomplects processing (the transducer) from accumulation.
</p>

<p>
Iteration is handled by the reduce API.
</p>

</section>
<section id="slide-org526e233">
<h3 id="org526e233">Into</h3>
<p>
Slightly less generic than transduce, will either <code>conj</code> or <code>conj!</code> into
the provided "sink" collection.
</p>

<div class="org-src-container">

<pre  class="src src-clojure"   ><code trim><span style="color: #4f97d7;">(</span>into to xf from<span style="color: #4f97d7;">)</span>
</code></pre>
</div>

<p>
Into just reduces with <code>conj</code> using <code>from</code> as the collection and <code>to</code> as
the initial value.
</p>

<p>
If a transducer is supplied, it wraps <code>conj</code>.
</p>

</section>
<section id="slide-orgf7923e1">
<h3 id="orgf7923e1">Sequence</h3>
<div class="outline-text-3" id="text-orgf7923e1">
</div>
</section>
<section id="slide-org459811f">
<h4 id="org459811f">The <code>map</code> of transducers</h4>
<p>
Takes a transducer and a collection,
</p>

<p>
Returns a lazy sequence of the transducer applied to the elements.
</p>

<p>
It can also take multiple inputs like <code>map</code>, applying the transducer to
the combined items from each coll, i.e. the first from all, then the
second from all, etc.
</p>

</section>
<section id="slide-org37d211c">
<h3 id="org37d211c">Eduction</h3>
<p>
The peek of laziness is not doing anything at all.
</p>

<p>
Returns a reducible/iterable application of the transducer to a
reducible.
</p>

<ul>
<li><code>sequence</code> returns a lazy sequence,</li>
<li><code>Eduction</code> is a promise of a reduction.</li>

</ul>

<p>
Implements the reduce interface but doesn't <i>do</i> anything until you
reduce over it.
</p>

<p>
These applications will be performed every time reduce/iterator
is called.
</p>

</section>
<section id="slide-org37d211c-split">

<h3>Eduction</h3>

<p>
Pros: They compose arbitrarily with very little overhead
</p>

<p>
Cons: Results are not cached, be careful not to reduce over an eduction
twice, unless you want to.
</p>

<p>
Lets set up a hypothetical example of plenty of nested sequences (they
happen)
</p>

</section>
<section id="slide-org37d211c-split">

<h3>Eduction</h3>

<div class="org-src-container">

<pre  class="src src-clojure"   ><code trim><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #7590db;">xs</span> <span style="color: #bc6ec5;">[</span><span style="color: #2d9574;">[</span><span style="color: #a45bad;">1</span> <span style="color: #a45bad;">2</span> <span style="color: #a45bad;">3</span><span style="color: #2d9574;">]</span> <span style="color: #2d9574;">[</span><span style="color: #a45bad;">4</span> <span style="color: #a45bad;">5</span> <span style="color: #a45bad;">6</span><span style="color: #2d9574;">]</span> <span style="color: #2d9574;">[</span><span style="color: #a45bad;">7</span> <span style="color: #a45bad;">8</span> <span style="color: #a45bad;">9</span><span style="color: #2d9574;">]</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #7590db;">ys</span> '<span style="color: #bc6ec5;">[</span><span style="color: #2d9574;">[</span>a b c<span style="color: #2d9574;">]</span> <span style="color: #2d9574;">[</span>x y z<span style="color: #2d9574;">]</span> <span style="color: #2d9574;">[</span>u v w<span style="color: #2d9574;">]</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #7590db;">zs</span> <span style="color: #bc6ec5;">(</span>mapv <span style="color: #2d9574;">(</span>partial mapv keyword<span style="color: #2d9574;">)</span> '<span style="color: #2d9574;">[</span><span style="color: #67b11d;">[</span>a b c<span style="color: #67b11d;">]</span> <span style="color: #67b11d;">[</span>x y z<span style="color: #67b11d;">]</span> <span style="color: #67b11d;">[</span>u v w<span style="color: #67b11d;">]</span><span style="color: #2d9574;">]</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
</code></pre>
</div>

</section>
<section id="slide-org37d211c-split">

<h3>Eduction</h3>

<p>
Had we wanted to concat them all, we might have written something like:
</p>

<div class="org-src-container">

<pre  class="src src-clojure"   ><code trim><span style="color: #4f97d7;">(</span>concat
 <span style="color: #bc6ec5;">(</span>apply concat xs<span style="color: #bc6ec5;">)</span>
 <span style="color: #bc6ec5;">(</span>apply concat ys<span style="color: #bc6ec5;">)</span>
 <span style="color: #bc6ec5;">(</span>apply concat zs<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
</code></pre>
</div>

<pre class="example">
(1 2 3 4 5 6 7 8 9 a b c x y z u v w :a :b :c :x :y :z :u :v :w)
</pre>

</section>
<section id="slide-orgf650214">
<h4 id="orgf650214"><code>cat</code> vs. <code>concat</code></h4>
<p>
<code>cat</code> is the transducing version of <code>concat</code>.
</p>

<p>
Where we'd write
</p>
<div class="org-src-container">

<pre  class="src src-clojure"   ><code trim><span style="color: #4f97d7;">(</span>concat <span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">1</span> <span style="color: #a45bad;">2</span> <span style="color: #a45bad;">3</span><span style="color: #bc6ec5;">]</span> <span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">4</span> <span style="color: #a45bad;">5</span> <span style="color: #a45bad;">6</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span> <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">=&gt; (1 2 3 4 5 6)</span>
</code></pre>
</div>

<p>
We can write
</p>
<div class="org-src-container">

<pre  class="src src-clojure"   ><code trim><span style="color: #4f97d7;">(</span>sequence cat <span style="color: #bc6ec5;">[</span><span style="color: #2d9574;">[</span><span style="color: #a45bad;">1</span> <span style="color: #a45bad;">2</span> <span style="color: #a45bad;">3</span><span style="color: #2d9574;">]</span> <span style="color: #2d9574;">[</span><span style="color: #a45bad;">4</span> <span style="color: #a45bad;">5</span> <span style="color: #a45bad;">6</span><span style="color: #2d9574;">]</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span> <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">=&gt; (1 2 3 4 5 6)</span>
<span style="color: #4f97d7;">(</span>-&gt;Eduction cat <span style="color: #bc6ec5;">[</span><span style="color: #2d9574;">[</span><span style="color: #a45bad;">1</span> <span style="color: #a45bad;">2</span> <span style="color: #a45bad;">3</span><span style="color: #2d9574;">]</span> <span style="color: #2d9574;">[</span><span style="color: #a45bad;">4</span> <span style="color: #a45bad;">5</span> <span style="color: #a45bad;">6</span><span style="color: #2d9574;">]</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span> <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">=&gt; (1 2 3 4 5 6)</span>
</code></pre>
</div>

<p>
Notice the need to pack the sequences in a wrapping sequence.
</p>

<p>
On the other hand, no more need to write <code>(apply concat ,,,)</code>
</p>

</section>
<section id="slide-orgf650214-split">

<h4><code>cat</code> vs. <code>concat</code></h4>

<p>
With eduction:
</p>

<div class="org-src-container">

<pre  class="src src-clojure"   ><code trim><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">defn</span> <span style="color: #bc6ec5; font-weight: bold;">caduction</span> <span style="color: #bc6ec5;">[</span>xs<span style="color: #bc6ec5;">]</span> <span style="color: #bc6ec5;">(</span>-&gt;Eduction cat xs<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>

<span style="color: #4f97d7;">(</span>caduction
 <span style="color: #bc6ec5;">[</span><span style="color: #2d9574;">(</span>caduction xs<span style="color: #2d9574;">)</span>
  <span style="color: #2d9574;">(</span>caduction ys<span style="color: #2d9574;">)</span>
  <span style="color: #2d9574;">(</span>caduction zs<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>
</code></pre>
</div>

<pre class="example">
(1 2 3 4 5 6 7 8 9 a b c x y z u v w :a :b :c :x :y :z :u :v :w)
</pre>


</section>
<section id="slide-orgf650214-split">

<h4><code>cat</code> vs. <code>concat</code></h4>

<p>
There are certainly performance benefits:
</p>

<div class="org-src-container">

<pre  class="src src-clojure"   ><code trim><span style="color: #4f97d7;">(</span>time
 <span style="color: #bc6ec5;">(</span><span style="color: #4f97d7; font-weight: bold;">dotimes</span> <span style="color: #2d9574;">[</span>_ <span style="color: #a45bad;">1e6</span><span style="color: #2d9574;">]</span>
   <span style="color: #2d9574;">(</span>count
    <span style="color: #67b11d;">(</span>concat
     <span style="color: #b1951d;">(</span>apply concat xs<span style="color: #b1951d;">)</span>
     <span style="color: #b1951d;">(</span>apply concat ys<span style="color: #b1951d;">)</span>
     <span style="color: #b1951d;">(</span>apply concat zs<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>

<span style="color: #2d9574;">"Elapsed time: 2214.169337 msecs"</span>
</code></pre>
</div>

</section>
<section id="slide-orgf650214-split">

<h4><code>cat</code> vs. <code>concat</code></h4>

<div class="org-src-container">

<pre  class="src src-clojure"   ><code trim><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #7590db;">incr</span> <span style="color: #bc6ec5;">(</span><span style="color: #4f97d7; font-weight: bold;">fn</span> <span style="color: #2d9574;">[</span><span style="color: #b2b2b2; background-color: #292b2e;">^</span><span style="color: #ce537a; font-weight: bold;">long</span> x _<span style="color: #2d9574;">]</span> <span style="color: #2d9574;">(</span>unchecked-inc x<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
<span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">Eduction isn't even countable so we need to count it ourselves</span>
<span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">defn</span> <span style="color: #bc6ec5; font-weight: bold;">-count</span>
  <span style="color: #bc6ec5;">[</span>xs<span style="color: #bc6ec5;">]</span>
  <span style="color: #bc6ec5;">(</span>reduce incr <span style="color: #a45bad;">0</span> xs<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>

<span style="color: #4f97d7;">(</span>time
 <span style="color: #bc6ec5;">(</span><span style="color: #4f97d7; font-weight: bold;">dotimes</span> <span style="color: #2d9574;">[</span>_ <span style="color: #a45bad;">1e6</span><span style="color: #2d9574;">]</span>
   <span style="color: #2d9574;">(</span>-count
    <span style="color: #67b11d;">(</span>caduction
     <span style="color: #b1951d;">[</span><span style="color: #4f97d7;">(</span>caduction xs<span style="color: #4f97d7;">)</span>
      <span style="color: #4f97d7;">(</span>caduction ys<span style="color: #4f97d7;">)</span>
      <span style="color: #4f97d7;">(</span>caduction zs<span style="color: #4f97d7;">)</span><span style="color: #b1951d;">]</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
<span style="color: #2d9574;">"Elapsed time: 402.897992 msecs"</span>
</code></pre>
</div>

</section>
<section id="slide-org295d09b">
<h3 id="org295d09b">Things which accept transducers</h3>
<ul>
<li>Channels</li>
<li>Pipelines</li>
<li>Reducers</li>
<li>Anything reducible</li>

</ul>

</section>
</section>
<section>
<section id="slide-org8bd34d3">
<h2 id="org8bd34d3">Performance</h2>
<p>
Transducers give a significant performance boost in comparison to
chained sequence operations, mainly due to two reasons
</p>

</section>
<section id="slide-orgaafc5d0">
<h3 id="orgaafc5d0">Allocation</h3>
<div class="outline-text-3" id="text-orgaafc5d0">
</div>
</section>
<section id="slide-orgbdb4a99">
<h4 id="orgbdb4a99">Sequence operations</h4>
<p>
sequence operations (map, filter) will produce intermediary lazy sequences.
</p>

<p>
If the input is chunked, the output will be chunked, too.
</p>

<p>
Assuming chunked inputs, every step will allocate an array holding 32
lazy values.
</p>

<div class="org-src-container">

<pre  class="src src-clojure"   ><code trim><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">-&gt;&gt;</span> xs <span style="color: #bc6ec5;">(</span>map f<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">(</span>map g<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">(</span>map h<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
</code></pre>
</div>

</section>
<section id="slide-orgb6edb0d">
<h4 id="orgb6edb0d">Sequence</h4>
<p>
<code>sequence</code> will produce only one chunked lazy sequence which encompasses the
entire computation
</p>

<div class="org-src-container">

<pre  class="src src-clojure"   ><code trim><span style="color: #4f97d7;">(</span>sequence <span style="color: #bc6ec5;">(</span>comp <span style="color: #2d9574;">(</span>map f<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">(</span>map g<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">(</span>map h<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span> xs<span style="color: #4f97d7;">)</span>
</code></pre>
</div>

</section>
<section id="slide-org9a153ef">
<h4 id="org9a153ef">Eduction</h4>
<p>
Eduction will produce a single allocation, and may only allocate as
little as one element at a time
</p>

<div class="org-src-container">

<pre  class="src src-clojure"   ><code trim><span style="color: #4f97d7;">(</span>-&gt;Eduction <span style="color: #bc6ec5;">(</span>comp <span style="color: #2d9574;">(</span>map f<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">(</span>map g<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">(</span>map h<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span> xs<span style="color: #4f97d7;">)</span>
</code></pre>
</div>

</section>
<section id="slide-org06717ec">
<h4 id="org06717ec">Transduce</h4>
<p>
transduce will allocate depending on <code>rf</code>'s behavior and <code>init</code>.
</p>

<div class="org-src-container">

<pre  class="src src-clojure"   ><code trim><span style="color: #4f97d7;">(</span>transduce <span style="color: #bc6ec5;">(</span>comp <span style="color: #2d9574;">(</span>map f<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">(</span>map g<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">(</span>map h<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span> rf init xs<span style="color: #4f97d7;">)</span>
</code></pre>
</div>

</section>
<section id="slide-orgd7da9c2">
<h4 id="orgd7da9c2">Therefor</h4>
<p>
In any use case, using transducers will reduce allocation pressure.
</p>

<p>
Moreover, the different APIs provide us with a choice on regarding
laziness which affects the allocation profile.
</p>

</section>
<section id="slide-org0078d47">
<h3 id="org0078d47">JIT Compilation</h3>
<p>
The JVM is a bytecode interpreter with a very clever Just In Time
compiler.
</p>

<p>
One of the things it is very good at optimizing is nested class method
calls.
</p>

<p>
Functions in Clojure are all class instances, calling them calls a
method they all implement.
</p>

</section>
<section id="slide-org0078d47-split">

<h3>JIT Compilation</h3>

<p>
Just like this:
</p>

<div class="org-src-container">

<pre  class="src src-clojure"   ><code trim><span style="color: #4f97d7;">(</span>map #<span style="color: #bc6ec5;">(</span><span style="color: #4f97d7; font-weight: bold;">-&gt;</span> <span style="color: #7590db;">%</span> f g h<span style="color: #bc6ec5;">)</span> xs<span style="color: #4f97d7;">)</span>
</code></pre>
</div>

<p>
Will be faster than:
</p>

<div class="org-src-container">

<pre  class="src src-clojure"   ><code trim><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">-&gt;&gt;</span> xs <span style="color: #bc6ec5;">(</span>map f<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">(</span>map g<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">(</span>map h<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
</code></pre>
</div>

<p>
(putting aside the intermediary lazy sequences)
</p>

</section>
<section id="slide-org0078d47-split">

<h3>JIT Compilation</h3>

<p>
So will
</p>

<div class="org-src-container">

<pre  class="src src-clojure"   ><code trim><span style="color: #4f97d7;">(</span>sequence <span style="color: #bc6ec5;">(</span>comp <span style="color: #2d9574;">(</span>map f<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">(</span>map g<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">(</span>map h<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span> xs<span style="color: #4f97d7;">)</span>
</code></pre>
</div>

<p>
Will be faster than:
</p>

<div class="org-src-container">

<pre  class="src src-clojure"   ><code trim><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">-&gt;&gt;</span> xs <span style="color: #bc6ec5;">(</span>map f<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">(</span>map g<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">(</span>map h<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
</code></pre>
</div>

</section>
<section id="slide-org0078d47-split">

<h3>JIT Compilation</h3>

<p>
And with transducers, we can also compose various sequence operations:
</p>

<div class="org-src-container">

<pre  class="src src-clojure"   ><code trim><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">-&gt;&gt;</span> xs
     <span style="color: #bc6ec5;">(</span>map f<span style="color: #bc6ec5;">)</span>
     <span style="color: #bc6ec5;">(</span>filter g<span style="color: #bc6ec5;">)</span>
     <span style="color: #bc6ec5;">(</span>partition-all <span style="color: #a45bad;">3</span><span style="color: #bc6ec5;">)</span>
     <span style="color: #bc6ec5;">(</span>map h<span style="color: #bc6ec5;">)</span>
     <span style="color: #bc6ec5;">(</span>filter p<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
<span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">=&gt;</span>
<span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #7590db;">xf</span> <span style="color: #bc6ec5;">(</span>comp <span style="color: #2d9574;">(</span>map f<span style="color: #2d9574;">)</span>
           <span style="color: #2d9574;">(</span>filter g<span style="color: #2d9574;">)</span>
           <span style="color: #2d9574;">(</span>partition-all <span style="color: #a45bad;">3</span><span style="color: #2d9574;">)</span>
           <span style="color: #2d9574;">(</span>map h<span style="color: #2d9574;">)</span>
           <span style="color: #2d9574;">(</span>filter p<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
</code></pre>
</div>

</section>
<section id="slide-org0078d47-split">

<h3>JIT Compilation</h3>

<p>
In both cases, we can and should <code>def</code> the composed function,
</p>

<p>
Will only be compiled to bytecode once
</p>

<p>
Over successive calls will be optimized by the JIT compiler.
</p>

<p>
Rather than creating new instances every call.
</p>

<div class="org-src-container">

<pre  class="src src-clojure"   ><code trim><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #7590db;">xf</span> <span style="color: #bc6ec5;">(</span>comp <span style="color: #2d9574;">(</span>map f<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">(</span>map g<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">(</span>map h<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
</code></pre>
</div>
</section>
</section>
</div>
</div>
<script src="https://cdn.jsdelivr.net/npm/reveal.js/dist/reveal.js"></script>

<script>
// Full list of configuration options available here:
// https://github.com/hakimel/reveal.js#configuration
Reveal.initialize({

// Optional libraries used to extend on reveal.js
dependencies: [
 { src: 'https://cdn.jsdelivr.net/npm/reveal.js/plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
 { src: 'https://cdn.jsdelivr.net/npm/reveal.js/plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
 { src: 'https://cdn.jsdelivr.net/npm/reveal.js/plugin/zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } },
 { src: 'https://cdn.jsdelivr.net/npm/reveal.js/plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } }]

});

</script>
</body>
</html>
